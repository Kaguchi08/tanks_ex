@page "/admin/test"
@using System.Text.Json
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ - Tanks Game</PageTitle>

<div class="test-page">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 mb-3">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h1>
            <p class="text-muted">ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™</p>
        </div>
    </div>

    <!-- Test Categories -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-wifi me-2"></i>æ¥ç¶šãƒ†ã‚¹ãƒˆ</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">MagicOnionã¨Blazorã®æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="TestMagicOnionConnection">
                            <i class="bi bi-server me-1"></i>MagicOnionæ¥ç¶šãƒ†ã‚¹ãƒˆ
                        </button>
                        <button class="btn btn-info" @onclick="TestBlazorConnection">
                            <i class="bi bi-lightning me-1"></i>Blazoræ¥ç¶šãƒ†ã‚¹ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-braces me-2"></i>ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">JSONå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" @onclick="TestJsonSerialization">
                            <i class="bi bi-code-square me-1"></i>JSONå¤‰æ›ãƒ†ã‚¹ãƒˆ
                        </button>
                        <button class="btn btn-warning" @onclick="GenerateSampleData">
                            <i class="bi bi-file-earmark-code me-1"></i>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-clipboard-data me-2"></i>ãƒ†ã‚¹ãƒˆçµæœ</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(testResults))
                    {
                        <div class="test-results">
                            <pre class="bg-dark text-light p-3 rounded">@testResults</pre>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-play-circle display-4"></i>
                            <p class="mt-2">ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Test Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-input-cursor-text me-2"></i>JSONå…¥åŠ›</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <textarea class="form-control font-monospace" rows="8" @bind="testJsonInput" 
                                  placeholder='{"test": "data", "number": 123}'></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-output-cursor me-2"></i>å¤‰æ›çµæœ</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(jsonTestResult))
                    {
                        <pre class="bg-light p-3 rounded font-monospace small">@jsonTestResult</pre>
                    }
                    else
                    {
                        <div class="text-muted text-center py-4">
                            <i class="bi bi-arrow-left-right"></i>
                            <p class="mt-2 small">JSONã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Test -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒ†ã‚¹ãƒˆ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-display">
                                <label class="text-muted small">ç¾åœ¨æ™‚åˆ»</label>
                                <div class="h4 text-primary font-monospace">@currentTime</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-display">
                                <label class="text-muted small">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</label>
                                <div class="h4 text-success">@counter</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="btn-group">
                            <button class="btn btn-primary" @onclick="StartAutoUpdate" disabled="@isAutoUpdating">
                                <i class="bi bi-play-fill me-1"></i>è‡ªå‹•æ›´æ–°é–‹å§‹
                            </button>
                            <button class="btn btn-danger" @onclick="StopAutoUpdate" disabled="@(!isAutoUpdating)">
                                <i class="bi bi-stop-fill me-1"></i>è‡ªå‹•æ›´æ–°åœæ­¢
                            </button>
                            <button class="btn btn-secondary" @onclick="IncrementCounter">
                                <i class="bi bi-plus-lg me-1"></i>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼+1
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-info w-100 mb-3" @onclick="GetSystemInfo">
                        <i class="bi bi-cpu me-1"></i>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—
                    </button>
                    @if (!string.IsNullOrEmpty(systemInfo))
                    {
                        <div class="system-info">
                            <pre class="small bg-light p-2 rounded">@systemInfo</pre>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string testResults = "";
    private string testJsonInput = "";
    private string jsonTestResult = "";
    private string systemInfo = "";
    private string currentTime = DateTime.Now.ToString("HH:mm:ss");
    private int counter = 0;
    private bool isAutoUpdating = false;
    private Timer? autoUpdateTimer;

    protected override void OnInitialized()
    {
        currentTime = DateTime.Now.ToString("HH:mm:ss");
    }

    private async Task TestMagicOnionConnection()
    {
        testResults = "";
        testResults += $"[{DateTime.Now:HH:mm:ss}] ğŸ”„ MagicOnionæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹\n";
        try
        {
            await Task.Delay(500); // Simulate test delay
            testResults += "âœ… MagicOnionã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™\n";
            testResults += "âœ… gRPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™\n";
            testResults += "âœ… HTTP/2ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª\n";
            testResults += "âœ… ã‚µãƒ¼ãƒãƒ¼ãƒãƒ–æ¥ç¶šå¯èƒ½\n";
            testResults += $"âœ… ãƒ†ã‚¹ãƒˆå®Œäº† ({DateTime.Now:HH:mm:ss})\n";
        }
        catch (Exception ex)
        {
            testResults += $"âŒ ã‚¨ãƒ©ãƒ¼: {ex.Message}\n";
        }
        StateHasChanged();
    }

    private async Task TestBlazorConnection()
    {
        testResults = "";
        testResults += $"[{DateTime.Now:HH:mm:ss}] ğŸ”„ Blazoræ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹\n";
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "Blazor JSãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ†ã‚¹ãƒˆ");
            await Task.Delay(300);
            testResults += "âœ… Blazor ServerãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™\n";
            testResults += "âœ… JavaScriptç›¸äº’é‹ç”¨ãŒåˆ©ç”¨å¯èƒ½ã§ã™\n";
            testResults += "âœ… SignalRæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã™\n";
            testResults += "âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒå‹•ä½œä¸­\n";
            testResults += $"âœ… ãƒ†ã‚¹ãƒˆå®Œäº† ({DateTime.Now:HH:mm:ss})\n";
        }
        catch (Exception ex)
        {
            testResults += $"âŒ ã‚¨ãƒ©ãƒ¼: {ex.Message}\n";
        }
        StateHasChanged();
    }

    private void TestJsonSerialization()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(testJsonInput))
            {
                jsonTestResult = "âŒ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                return;
            }

            var parsedJson = JsonSerializer.Deserialize<object>(testJsonInput);
            var serializedJson = JsonSerializer.Serialize(parsedJson, new JsonSerializerOptions { WriteIndented = true });
            jsonTestResult = $"âœ… JSONè§£ææˆåŠŸ:\n\n{serializedJson}";
        }
        catch (Exception ex)
        {
            jsonTestResult = $"âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:\n{ex.Message}";
        }
        StateHasChanged();
    }

    private void GenerateSampleData()
    {
        var sampleData = new
        {
            playerId = Guid.NewGuid().ToString(),
            playerName = "TestPlayer",
            position = new { x = 10.5f, y = 0.0f, z = 5.2f },
            rotation = new { x = 0.0f, y = 45.0f, z = 0.0f },
            health = 100,
            ammo = 50,
            timestamp = DateTime.Now,
            isActive = true,
            gameSettings = new
            {
                maxPlayers = 4,
                gameMode = "Deathmatch",
                mapName = "Arena_01"
            }
        };

        testJsonInput = JsonSerializer.Serialize(sampleData, new JsonSerializerOptions { WriteIndented = true });
        StateHasChanged();
    }

    private void GetSystemInfo()
    {
        systemInfo = $"æ™‚åˆ»: {DateTime.Now:yyyy/MM/dd HH:mm:ss}\n" +
                    $".NET: {Environment.Version}\n" +
                    $"OS: {Environment.OSVersion}\n" +
                    $"ãƒã‚·ãƒ³: {Environment.MachineName}\n" +
                    $"CPUæ•°: {Environment.ProcessorCount}\n" +
                    $"ä½œæ¥­Dir: {Environment.CurrentDirectory}";
        StateHasChanged();
    }

    private void StartAutoUpdate()
    {
        if (isAutoUpdating) return;
        
        isAutoUpdating = true;
        autoUpdateTimer = new Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                currentTime = DateTime.Now.ToString("HH:mm:ss");
                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
        StateHasChanged();
    }

    private void StopAutoUpdate()
    {
        isAutoUpdating = false;
        autoUpdateTimer?.Dispose();
        autoUpdateTimer = null;
        StateHasChanged();
    }

    private void IncrementCounter()
    {
        counter++;
        StateHasChanged();
    }

    public void Dispose()
    {
        autoUpdateTimer?.Dispose();
    }
}