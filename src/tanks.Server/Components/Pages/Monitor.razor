@page "/admin/monitor"
@using Tanks.Server.Services
@inject IPlayerManagerService PlayerManager
@inject IGameStateService GameStateService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– - Tanks Game</PageTitle>

<div class="monitor-page">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 mb-3">ğŸ“ˆ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</h1>
            <p class="text-muted">ã‚µãƒ¼ãƒãƒ¼ã¨ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã—ã¾ã™</p>
        </div>
    </div>

    <!-- Real-time Metrics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>@activePlayerCount</h4>
                    <p class="mb-0">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>@totalConnectionCount</h4>
                    <p class="mb-0">ç·æ¥ç¶šæ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>@uptime</h4>
                    <p class="mb-0">ç¨¼åƒæ™‚é–“</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card @(currentGameState == "å®Ÿè¡Œä¸­" ? "bg-warning" : "bg-secondary") text-white">
                <div class="card-body text-center">
                    <h4>@currentGameState</h4>
                    <p class="mb-0">ã‚²ãƒ¼ãƒ çŠ¶æ…‹</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ç›£è¦–è¨­å®š</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" @bind="autoRefresh" @bind:after="ToggleAutoRefresh">
                        <label class="form-check-label">è‡ªå‹•æ›´æ–° (@(refreshInterval)ç§’é–“éš”)</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ›´æ–°é–“éš” (ç§’)</label>
                        <input type="range" class="form-range" min="1" max="10" @bind="refreshInterval" @bind:after="UpdateRefreshInterval">
                        <small class="form-text text-muted">ç¾åœ¨: @(refreshInterval)ç§’</small>
                    </div>
                    <button class="btn btn-primary" @onclick="ManualRefresh">æ‰‹å‹•æ›´æ–°</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h5>
                </div>
                <div class="card-body">
                    <div class="status-indicator mb-2">
                        <span class="badge bg-success me-2">â—</span>
                        <span>MagicOnionã‚µãƒ¼ãƒãƒ¼: æ­£å¸¸</span>
                    </div>
                    <div class="status-indicator mb-2">
                        <span class="badge bg-success me-2">â—</span>
                        <span>Blazorã‚µãƒ¼ãƒãƒ¼: æ­£å¸¸</span>
                    </div>
                    <div class="status-indicator mb-2">
                        <span class="badge @(PlayerManager.IsGameReady() ? "bg-success" : "bg-warning") me-2">â—</span>
                        <span>ã‚²ãƒ¼ãƒ æº–å‚™: @(PlayerManager.IsGameReady() ? "å®Œäº†" : "å¾…æ©Ÿä¸­")</span>
                    </div>
                    <div class="status-indicator">
                        <span class="badge bg-info me-2">â—</span>
                        <span>æœ€çµ‚æ›´æ–°: @lastUpdate.ToString("HH:mm:ss")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Activity Feed -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ãƒ©ã‚¤ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰</h5>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFeed">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="card-body p-0">
                    <div class="activity-feed" style="max-height: 400px; overflow-y: auto;">
                        @foreach (var activity in activityFeed)
                        {
                            <div class="activity-item p-3 border-bottom">
                                <div class="d-flex justify-content-between">
                                    <span class="activity-message">@activity.Message</span>
                                    <small class="text-muted">@activity.Timestamp.ToString("HH:mm:ss")</small>
                                </div>
                                <div class="activity-type">
                                    <span class="badge @GetActivityBadgeClass(activity.Type)">@activity.Type</span>
                                </div>
                            </div>
                        }
                        @if (!activityFeed.Any())
                        {
                            <div class="text-center py-4 text-muted">
                                ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool autoRefresh = true;
    private int refreshInterval = 3;
    private DateTime startTime = DateTime.Now;
    private DateTime lastUpdate = DateTime.Now;
    private string uptime => (DateTime.Now - startTime).ToString(@"hh\:mm\:ss");
    private int activePlayerCount;
    private int totalConnectionCount;
    private string currentGameState = "Unknown";
    private Timer? refreshTimer;
    private List<ActivityItem> activityFeed = new();

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        AddActivity("ç›£è¦–ãƒšãƒ¼ã‚¸ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ", "System");
        if (autoRefresh)
        {
            StartAutoRefresh();
        }
    }

    private async Task RefreshData()
    {
        try
        {
            var previousPlayerCount = activePlayerCount;
            var previousGameState = currentGameState;

            activePlayerCount = PlayerManager.GetActivePlayerCount();
            totalConnectionCount = PlayerManager.GetTotalConnectionCount();
            currentGameState = GameStateService.GetCurrentState();
            lastUpdate = DateTime.Now;

            // Check for changes and log them
            if (previousPlayerCount != activePlayerCount)
            {
                AddActivity($"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: {previousPlayerCount} â†’ {activePlayerCount}", "Player");
            }
            if (previousGameState != currentGameState && previousGameState != "Unknown")
            {
                AddActivity($"ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: {previousGameState} â†’ {currentGameState}", "Game");
            }
        }
        catch (Exception ex)
        {
            AddActivity($"ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}", "Error");
        }
    }

    private void ToggleAutoRefresh()
    {
        if (autoRefresh)
        {
            StartAutoRefresh();
            AddActivity("è‡ªå‹•æ›´æ–°ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ", "System");
        }
        else
        {
            StopAutoRefresh();
            AddActivity("è‡ªå‹•æ›´æ–°ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ", "System");
        }
    }

    private void UpdateRefreshInterval()
    {
        if (autoRefresh)
        {
            StopAutoRefresh();
            StartAutoRefresh();
            AddActivity($"æ›´æ–°é–“éš”ãŒ{refreshInterval}ç§’ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ", "System");
        }
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(refreshInterval));
    }

    private void StopAutoRefresh()
    {
        refreshTimer?.Dispose();
        refreshTimer = null;
    }

    private async Task ManualRefresh()
    {
        await RefreshData();
        AddActivity("æ‰‹å‹•æ›´æ–°ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ", "System");
    }

    private void ClearFeed()
    {
        activityFeed.Clear();
        AddActivity("ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ", "System");
    }

    private void AddActivity(string message, string type)
    {
        activityFeed.Insert(0, new ActivityItem
        {
            Message = message,
            Type = type,
            Timestamp = DateTime.Now
        });

        // Keep only the last 50 activities
        if (activityFeed.Count > 50)
        {
            activityFeed.RemoveRange(50, activityFeed.Count - 50);
        }
    }

    private string GetActivityBadgeClass(string type)
    {
        return type switch
        {
            "System" => "bg-primary",
            "Player" => "bg-info",
            "Game" => "bg-success",
            "Error" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }

    private class ActivityItem
    {
        public string Message { get; set; } = "";
        public string Type { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}
}